<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Coffee Intelligence | Command Center</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'panel-bg': 'rgba(15, 23, 42, 0.95)',
                        'panel-border': '#334155',
                        'cat-supply': '#10b981',
                        'cat-demand': '#3b82f6',
                        'cat-stocks': '#f59e0b',
                        'cat-futures': '#8b5cf6',
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body, html { height: 100%; margin: 0; background-color: #1a1a1a; color: #e5e5e5; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; background: #242424; }
        .custom-icon { transition: all 0.2s ease-in-out; }
        
        .data-icon { border: 2px solid #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .data-icon.producer { background: #10b981; }
        .data-icon.consumer { background: #3b82f6; }
        .data-icon.harvesting { background: #10b981; border: 2px solid #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4); animation: pulse-ring 2s infinite; }

        .factory-icon { background: #6366f1; border: 1px solid #fff; border-radius: 3px; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.3); font-size: 9px; }
        .factory-icon:hover { transform: scale(1.3); z-index: 900; background: #4f46e5; }

        .port-icon { background: #0ea5e9; border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 8px rgba(14, 165, 233, 0.6); color: #fff; font-size: 10px; }
        .port-icon:hover { transform: scale(1.2); z-index: 1000; }

        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        @keyframes flow-motion { to { stroke-dashoffset: -32; } }
        .route-flow { stroke-dasharray: 8, 8 !important; animation: flow-motion 3s linear infinite; will-change: stroke-dashoffset; }
        .route-flow:hover { stroke-width: 4px; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }

        #global-panel { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #global-panel.retracted { transform: translateY(calc(100% - 36px)); }
        
        .news-card { background: rgba(30, 41, 59, 0.5); border-left: 3px solid; padding: 8px 12px; margin-bottom: 8px; border-radius: 0 4px 4px 0; font-size: 0.8rem; line-height: 1.4; }
        .leaflet-popup-content-wrapper { background: rgba(15, 23, 42, 0.95); color: #e2e8f0; border: 1px solid #334155; border-radius: 6px; }
        .leaflet-popup-tip { background: #334155; }
        
        .osint-ticker-wrap { flex: 1; position: relative; overflow: hidden; background: transparent; display: flex; align-items: center; margin: 0 20px; height: 100%; mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent); }
        .osint-ticker { display: inline-block; white-space: nowrap; animation: osint-scroll 60s linear infinite; padding-left: 100%; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #94a3b8; }
        .osint-item { margin-right: 30px; display: inline-flex; align-items: center; gap: 6px; }
        .osint-val-up { color: #4ade80; font-weight: 700; }
        .osint-val-down { color: #f87171; font-weight: 700; }
        .osint-val-risk { color: #fb923c; font-weight: 700; }
        .osint-val-neutral { color: #38bdf8; font-weight: 700; }
        .osint-label { font-weight: 700; color: #cbd5e1; opacity: 0.8; }
        @keyframes osint-scroll { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="global-panel" class="absolute bottom-0 left-0 w-full h-[320px] bg-panel-bg border-t border-panel-border z-[1000] shadow-[0_-4px_20px_rgba(0,0,0,0.5)] flex flex-col backdrop-blur-md">
        <div id="panel-toggle" class="h-[36px] bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 cursor-pointer hover:bg-slate-800 transition-colors" onclick="App.ui.togglePanel()">
            <div class="flex items-center gap-3 shrink-0"><div class="font-mono font-bold text-sm text-gray-100 tracking-wider">GLOBAL MARKET INTEL</div></div>
            <div class="osint-ticker-wrap">
                <div class="osint-ticker">
                    <span class="osint-item"><span class="osint-label">SYSTEM</span> <span class="osint-val-neutral">LOADING DATA...</span></span>
                </div>
            </div>
            <div class="text-gray-400 hover:text-white transition-transform duration-300 shrink-0" id="toggle-icon"><i class="fa-solid fa-chevron-down"></i></div>
        </div>

        <div class="flex-1 grid grid-cols-4 divide-x divide-slate-700 overflow-hidden">
            <div class="flex flex-col min-h-0"><div class="p-3 bg-slate-900/50 text-xs font-bold text-cat-supply border-b border-slate-700 flex items-center gap-2 uppercase"><i class="fa-solid fa-wheat-awn"></i> Supply & Harvest</div><div id="col-supply" class="p-3 overflow-y-auto custom-scroll flex-1"><div class="text-gray-500 text-xs italic text-center mt-10">Loading...</div></div></div>
            <div class="flex flex-col min-h-0"><div class="p-3 bg-slate-900/50 text-xs font-bold text-cat-demand border-b border-slate-700 flex items-center gap-2 uppercase"><i class="fa-solid fa-cart-shopping"></i> Global Demand</div><div id="col-demand" class="p-3 overflow-y-auto custom-scroll flex-1"><div class="text-gray-500 text-xs italic text-center mt-10">Loading...</div></div></div>
            <div class="flex flex-col min-h-0"><div class="p-3 bg-slate-900/50 text-xs font-bold text-cat-stocks border-b border-slate-700 flex items-center gap-2 uppercase"><i class="fa-solid fa-cubes-stacked"></i> Certified Stocks</div><div id="col-stocks" class="p-3 overflow-y-auto custom-scroll flex-1"><div class="text-gray-500 text-xs italic text-center mt-10">Loading...</div></div></div>
            <div class="flex flex-col min-h-0"><div class="p-3 bg-slate-900/50 text-xs font-bold text-cat-futures border-b border-slate-700 flex items-center gap-2 uppercase"><i class="fa-solid fa-chart-line"></i> Futures / COT / FX</div><div id="col-futures" class="p-3 overflow-y-auto custom-scroll flex-1"><div class="text-gray-500 text-xs italic text-center mt-10">Loading...</div></div></div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[1999] hidden" onclick="App.ui.closeAiModal()"></div>
    <div id="ai-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[650px] max-w-[90%] max-h-[85vh] bg-slate-900 rounded-lg shadow-2xl z-[2000] hidden flex-col border border-slate-700">
        <div class="bg-slate-800 px-5 py-3 border-b border-slate-700 flex justify-between items-center rounded-t-lg">
            <h3 class="font-bold text-gray-100 flex items-center gap-2"><i class="fa-solid fa-microchip text-indigo-400"></i> <span id="ai-modal-title">Analysis</span></h3>
            <button onclick="App.ui.closeAiModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="ai-modal-content" class="p-6 overflow-y-auto text-sm text-gray-300 leading-relaxed font-sans"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

    <script>
        const CONFIG = {
            mapTheme: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            initView: [20, -10],
            initZoom: 3
        };

        const CoffeeData = {
            countries: {},
            globalIntel: { supply: [], demand: [], stocks: [], futures: [], ticker: [], alerts: [] },
            factories: [],
            ports: [
                { n: "Santos", l: [-23.9, -46.3] }, { n: "Vitoria", l: [-20.3, -40.3] }, { n: "Salvador", l: [-12.97, -38.50] },
                { n: "Cartagena", l: [10.4, -75.5] }, { n: "Buenaventura", l: [3.88, -77.0] }, { n: "Puerto Cortés", l: [15.8, -87.9] },
                { n: "Veracruz", l: [19.17, -96.13] }, { n: "Ho Chi Minh City", l: [10.7, 106.6] }, { n: "Jakarta", l: [-6.1, 106.8] },
                { n: "Mombasa", l: [-4.0, 39.6] }, { n: "Chennai", l: [13.08, 80.27] }, { n: "Tuticorin", l: [8.76, 78.13] },
                { n: "Antwerp", l: [51.22, 4.40] }, { n: "Hamburg", l: [53.55, 9.99] }, { n: "Trieste", l: [45.65, 13.78] },
                { n: "New York", l: [40.7, -74.0] }, { n: "New Orleans", l: [29.9, -90.0] }, 
                { n: "Le Havre", l: [49.49, 0.10] }, { n: "Basel", l: [47.55, 7.59] },
                { n: "London (Gateway)", l: [51.50, 0.50] },
                { n: "Genoa", l: [44.41, 8.93] },
                { n: "Algiers", l: [36.77, 3.06] },
                { n: "Shanghai", l: [31.23, 121.47] },
                { n: "Djibouti", l: [11.82, 43.14] },
                { n: "Sydney", l: [-33.86, 151.20] },
                { n: "Vienna", l: [48.20, 16.37] },
                { n: "Budapest", l: [47.49, 19.04] },
                { n: "Katowice", l: [50.26, 19.02] },
                { n: "Gioia Tauro", l: [38.43, 15.91] } // Added Gioia Tauro
            ],
            routes: [
                // --- MAIN TRUNKS (White) ---
                {
                    name: "English Channel Trunk",
                    color: "#ffffff",
                    weight: 4,
                    path: [
                        [48.0, -7.0], // Western Approaches
                        [49.5, -3.5], // Mid Channel
                        [50.5, 0.0], // East Channel (Clear of Cherbourg)
                        [51.2, 1.8], // Strait of Dover
                        [52.0, 3.0], // Southern North Sea
                        [53.5, 6.0], // Off Frisian Islands
                        [54.0, 8.0], // German Bight
                        [53.55, 9.99] // Hamburg
                    ]
                },
                {
                    name: "Mediterranean Trunk",
                    color: "#ffffff",
                    weight: 4,
                    path: [
                        [12.6, 43.3], // Bab el Mandeb
                        [18.0, 40.0], [22.0, 38.0], [27.0, 34.5], [29.5, 32.55], // Red Sea
                        [31.2, 32.3], [32.5, 31.0], [34.0, 25.0], // Suez & East Med
                        [36.0, 15.0] // Junction: South of Sicily/Malta
                    ]
                },
                { 
                    name: "Indian Ocean Trunk", 
                    color: "#ffffff",
                    weight: 4, 
                    path: [
                        [1.26, 103.8], [3.0, 100.5], [5.5, 98.0], [5.8, 95.5], // Malacca Strait
                        [5.8, 80.4], [10.0, 65.0], // Crossing Indian Ocean, staying North
                        [14.0, 55.0], // Safe point East of Socotra/Somalia
                        [12.5, 45.0], [12.6, 43.3] // Joins Med Trunk at Bab el Mandeb
                    ]
                },

                // --- FEEDERS TO TRUNKS ---
                { 
                    name: "Uganda -> Med Trunk (Feeder)", 
                    color: "#f39c12", 
                    path: [
                        [-4.04, 39.66], // Mombasa Port
                        [-4.0, 42.0], [0.0, 48.0], [5.0, 55.0], [12.0, 52.0], [12.5, 45.0], [12.6, 43.3] // Sea to Bab el Mandeb
                    ]
                },
                { 
                    name: "Feeder: Djibouti -> Med Trunk", 
                    color: "#f39c12", 
                    path: [
                        [11.82, 43.14], // Djibouti
                        [12.2, 43.5], 
                        [12.6, 43.3] // Joins at Bab el Mandeb
                    ]
                },
                { 
                    name: "Singapore -> Sydney", 
                    color: "#e74c3c", 
                    // Navigating the Indonesian Archipelago (Java Sea -> Banda Sea -> Torres Strait) to Australia
                    path: [
                        [1.26, 103.8],   // Singapore
                        [-1.0, 105.0],   // South China Sea exit
                        [-3.0, 107.0],   // Karimata Strait
                        [-5.0, 112.0],   // Java Sea
                        [-6.0, 120.0],   // Flores Sea
                        [-7.5, 128.0],   // Banda Sea
                        [-9.5, 135.0],   // Arafura Sea (North of Australia)
                        [-10.2, 142.0],  // Torres Strait (Critical Choke Point)
                        [-13.0, 146.0],  // Coral Sea (North)
                        [-20.0, 152.0],  // Coral Sea (Offshore QLD)
                        [-30.0, 154.0],  // Tasman Sea Approach
                        [-33.86, 151.20] // Sydney
                    ]
                },

                // --- BRANCHES FROM MED TRUNK ---
                { 
                    name: "Branch: Med -> Trieste", 
                    color: "#f39c12", 
                    // Splits from White Trunk at [36.0, 15.0]
                    path: [[36.0, 15.0], [39.8, 19.2], [42.5, 16.0], [44.5, 13.5], [45.64, 13.76]] 
                },
                { 
                    name: "Branch: Med -> Gioia Tauro", 
                    color: "#f39c12", 
                    // Major Southern Italy Hub - Deviation from Trunk
                    path: [[36.0, 15.0], [37.5, 16.0], [38.43, 15.91]] 
                },
                { 
                    name: "Branch: Med -> Genoa", 
                    color: "#16a085", 
                    // Splits from Med Trunk near Tunisia/Sardinia gap
                    // Carefully threading between islands (Sardinia/Corsica) and Italy
                    path: [
                        [37.5, 10.0], // Split point from Channel route below
                        [39.0, 11.0], // East of Sardinia
                        [41.5, 10.5], // East of Corsica / West of Italy
                        [43.5, 9.5],  // Approach Genoa
                        [44.41, 8.93] // Genoa
                    ]
                },
                { 
                    name: "Branch: Med -> Algiers", 
                    color: "#16a085", 
                    // Deviates from the trans-mediterranean lane
                    path: [[37.3, 4.0], [36.77, 3.06]] 
                },
                { 
                    name: "Branch: Med -> Channel", 
                    color: "#16a085", 
                    // Splits from White Trunk at [36.0, 15.0] -> Gibraltar -> Channel
                    path: [[36.0, 15.0], [37.5, 10.0], [37.0, 0.0], [36.0, -5.3], [37.0, -10.0], [43.0, -11.0], [48.0, -7.0]] 
                },

                // --- CHANNEL DEVIATIONS/SPURS ---
                { 
                    name: "Spur: Channel -> Le Havre", 
                    color: "#16a085", 
                    // Branches off mid-channel to clear Cherbourg
                    path: [[50.0, -1.0], [49.8, 0.0], [49.49, 0.10]] 
                },
                { 
                    name: "Spur: Channel -> London", 
                    color: "#16a085", 
                    path: [[51.2, 1.8], [51.5, 1.0], [51.50, 0.50]] 
                },
                { 
                    name: "Spur: Channel -> Antwerp", 
                    color: "#16a085", 
                    path: [[51.6, 2.5], [51.4, 3.5], [51.26, 4.35]] 
                },
                { 
                    name: "Deviation: Trunk -> Barcelona", 
                    color: "#16a085", 
                    path: [[37.5, 3.0], [39.0, 2.5], [41.38, 2.17]] 
                },
                { 
                    name: "Inland: Antwerp -> Basel (Swiss)", 
                    color: "#2c3e50", 
                    path: [[51.26, 4.35], [50.9, 6.9], [49.5, 8.4], [48.6, 7.8], [47.55, 7.59]] 
                },

                // --- ASIA FEEDERS (Hub & Spoke) ---
                { 
                    name: "Feeder: HCMC -> Singapore", 
                    color: "#2ecc71", 
                    path: [[10.76, 106.78], [8.0, 106.0], [3.0, 105.0], [1.26, 103.8]] 
                },
                { 
                    name: "Feeder: Jakarta -> Singapore", 
                    color: "#9b59b6", 
                    path: [[-6.10, 106.88], [-3.0, 106.0], [1.26, 103.8]] 
                },
                { 
                    name: "Inland: Lampung -> Jakarta", 
                    color: "#2c3e50", 
                    path: [[-5.43, 105.26], [-5.9, 106.0], [-6.10, 106.88]] 
                },
                { 
                    name: "Singapore -> US West", 
                    color: "#2ecc71", 
                    type: "multi", 
                    path: [
                        [[1.26, 103.8], [5.0, 108.0], [10.0, 112.0], [18.0, 118.0], [22.0, 122.0], [25.0, 126.0], [30.0, 135.0], [35.0, 150.0], [40.0, 170.0], [45.0, 180.0]], 
                        [[45.0, -180.0], [45.0, -160.0], [42.0, -140.0], [37.8, -122.4]]
                    ]
                },
                
                // --- ASIA DEVIATIONS ---
                { 
                    name: "Deviation: Trunk -> Tuticorin", 
                    color: "#00875a", 
                    path: [[5.8, 80.4], [7.5, 79.0], [8.76, 78.13]] 
                },
                { 
                    name: "Deviation: Trunk -> Chennai", 
                    color: "#00875a", 
                    path: [[5.8, 95.5], [10.0, 90.0], [13.08, 80.27]] 
                },
                { 
                    name: "Deviation: US Trunk -> Japan", 
                    color: "#2ecc71", 
                    path: [[30.0, 135.0], [33.0, 137.0], [35.61, 139.78]] 
                },

                // --- BRAZIL & AMERICAS ---
                { 
                    name: "Sea: Veracruz -> New Orleans",
                    color: "#9b59b6",
                    path: [[19.17, -96.13], [22.0, -95.0], [26.0, -92.0], [29.9, -90.0]]
                },
                { 
                    name: "Brazil (Santos) -> Channel Entry", 
                    color: "#e74c3c", 
                    path: [[-23.95, -46.3], [-25.0, -44.0], [-20.0, -36.0], [-10.0, -32.0], [-5.0, -31.0], [5.0, -28.0], [20.0, -25.0], [40.0, -15.0], [48.0, -7.0]]
                },
                { 
                    name: "Deviation: Salvador -> Channel Route",
                    color: "#e74c3c",
                    path: [[-12.97, -38.50], [-13.0, -35.0], [-10.0, -32.0]]
                },
                { 
                    name: "Brazil (Santos) -> NY", 
                    color: "#e74c3c", 
                    path: [[-23.95, -46.3], [-24.5, -44.0], [-20.0, -38.0], [-10.0, -34.0], [-5.0, -34.5], [5.0, -45.0], [15.0, -55.0], [25.0, -68.0], [32.0, -74.0], [38.0, -73.0], [40.5, -73.8]]
                },
                {
                    name: "Deviation: Vitoria -> US",
                    color: "#e74c3c",
                    path: [[-20.3, -40.3], [-20.0, -38.0]]
                },
                { 
                    name: "Brazil (Santos) -> Japan", 
                    color: "#e74c3c", 
                    // UPDATED: Follows same lane as Singapore -> US West trunk
                    path: [
                        [-23.95, -46.3], [-28.0, -40.0], [-34.0, -20.0], [-36.0, 0.0], [-36.0, 15.0], 
                        [-35.0, 25.0], [-30.0, 50.0], [-20.0, 70.0], [-10.0, 80.0], [-5.0, 88.0], [0.0, 92.0], 
                        [5.8, 95.5], [5.5, 98.0], [3.0, 100.5], [1.26, 103.8], // To Singapore
                        [5.0, 108.0], [10.0, 112.0], [18.0, 118.0], [22.0, 122.0], [25.0, 126.0], [30.0, 135.0], // Following Green Trunk
                        [33.0, 137.0], [35.61, 139.78] // Deviation to Japan
                    ]
                },
                { 
                    name: "Deviation: Trunk -> Shanghai",
                    color: "#e74c3c", // Red to denote Brazil Origin as requested
                    // Branches off East of Taiwan
                    path: [[22.0, 122.0], [26.0, 122.0], [31.23, 121.47]]
                },
                { name: "Honduras -> Channel Entry", color: "#3498db", 
                  path: [[15.8, -87.9],[18.5,-86.5],[21.8,-85.5],[24.5,-81],[30,-75],[35,-60],[42,-40],[48.0,-7.0]] 
                },
                
                // --- INLAND / SHORT ROUTES ---
                { name: "Inland: Uganda -> Mombasa", color: "#2c3e50", path: [[0.31, 32.58], [0.63, 34.27], [0.51, 35.26], [-0.30, 36.08], [-1.29, 36.82], [-4.04, 39.66]] },
                { 
                    name: "Inland: Ethiopia -> Djibouti", 
                    color: "#2c3e50", 
                    // Addis Ababa -> Adama -> Awash -> Djibouti (Rail/Road corridor)
                    path: [[9.145, 40.4897], [8.54, 39.27], [9.0, 40.1], [9.6, 41.8], [11.82, 43.14]] 
                },
                // --- CENTRAL EUROPE RAIL CORRIDORS ---
                { 
                    name: "Rail: Trieste -> Vienna", 
                    color: "#2c3e50", 
                    // Through Ljubljana and Graz
                    path: [[45.65, 13.78], [46.0, 14.5], [47.0, 15.4], [48.20, 16.37]] 
                },
                { 
                    name: "Rail: Trieste -> Budapest", 
                    color: "#2c3e50", 
                    // Through Ljubljana -> Maribor -> Lake Balaton
                    path: [[45.65, 13.78], [46.0, 14.5], [46.5, 15.6], [46.8, 17.7], [47.49, 19.04]] 
                },
                { 
                    name: "Rail: Vienna -> South Poland", 
                    color: "#2c3e50", 
                    // Vienna -> Ostrava -> Katowice
                    path: [[48.20, 16.37], [49.2, 17.0], [49.8, 18.2], [50.26, 19.02]] 
                },
                { name: "Rail: Trieste -> Antwerp", color: "#2c3e50", path: [[45.64, 13.76], [46.6, 13.8], [47.8, 13.0], [48.1, 11.5], [48.7, 9.1], [50.0, 8.2], [50.3, 7.6], [50.9, 6.9], [51.26, 4.35]] },
                { name: "Rail: Trieste -> Hamburg", color: "#2c3e50", path: [[45.64, 13.76], [46.6, 13.8], [47.8, 13.0], [49.4, 11.1], [51.3, 9.9], [53.53, 9.96]] },
                { name: "Inland: Rondonia -> Santos", color: "#2c3e50", path: [[-11.4, -61.5], [-15.6, -56.1], [-18.9, -48.3], [-22.5, -47.0], [-23.95, -46.3]] },
                { name: "Inland: Linhares -> Vitoria", color: "#2c3e50", path: [[-19.39, -40.07], [-20.31, -40.33]] },
                { name: "Inland: Varginha -> Santos", color: "#2c3e50", path: [[-21.55, -45.43], [-23.0, -46.0], [-23.95, -46.3]] },
                { name: "Inland: Bahia -> Salvador", color: "#2c3e50", path: [[-14.86, -40.84], [-12.96, -38.50]] },
                { name: "Inland: Buon Ma Thuot -> HCMC", color: "#2c3e50", path: [[12.66, 108.04], [11.3, 107.5], [10.76, 106.78]] },
                { 
                    name: "Inland: Armenia -> Buenaventura", 
                    color: "#2c3e50", 
                    path: [[4.53, -75.67], [4.31, -76.07], [3.90, -76.30], [3.88, -77.06]] 
                },
                { 
                    name: "Inland: Armenia -> Cartagena", 
                    color: "#2c3e50", 
                    path: [[4.53, -75.67], [4.81, -75.69], [6.24, -75.58], [7.98, -75.20], [9.30, -75.40], [10.40, -75.52]] 
                },
                { name: "Inland: Comayagua -> Pto Cortes", color: "#2c3e50", path: [[14.46, -87.64], [15.2, -87.9], [15.84, -87.94]] },
                
                { name: "Colombia -> NY", color: "#9b59b6", path: [[10.4, -75.5],[12,-76],[19.5,-74.5],[24,-73],[32,-74],[40.7,-74]] },
                { name: "Colombia -> Oakland", color: "#9b59b6", path: [[3.88, -77.0],[5,-80],[10,-88], [15,-98],[20,-108],[28,-116],[33,-120],[37.8,-122.4]] },
                { name: "Honduras -> NOLA", color: "#3498db", path: [[15.8, -87.9],[18.5,-86.5],[21.8,-86],[24.5,-88],[29,-89],[29.9,-90]] }
            ]
        };

        const App = {
            map: null,
            layers: { producers: null, consumers: null, factories: null, logistics: null, ports: null, newsAlerts: null, intel: null },
            
            init: async function() {
                // 1. Initialisation de la carte
                this.map = L.map('map', { zoomControl: false, fadeAnimation: true }).setView(CONFIG.initView, CONFIG.initZoom);
                this.map.createPane('labelsPane').style.zIndex = 550;
                this.map.getPane('labelsPane').style.pointerEvents = 'none';
                this.map.createPane('alertPane').style.zIndex = 650; 
                this.map.getPane('alertPane').style.pointerEvents = 'none';

                L.tileLayer(CONFIG.mapTheme, { attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(this.map);
                L.control.zoom({ position: 'topright' }).addTo(this.map);

                this.layers.producers = L.layerGroup().addTo(this.map);
                this.layers.consumers = L.layerGroup().addTo(this.map);
                this.layers.factories = L.layerGroup().addTo(this.map);
                this.layers.logistics = L.layerGroup().addTo(this.map);
                this.layers.ports = L.layerGroup().addTo(this.map);
                this.layers.newsAlerts = L.layerGroup().addTo(this.map);
                this.layers.intel = L.layerGroup().addTo(this.map);

                // 2. Charger les données JSON (Anti-cache)
                const timestamp = new Date().getTime();
                try {
                    const [countriesRes, globalRes, factoriesRes] = await Promise.all([
                        fetch('./countries.json?v=' + timestamp),
                        fetch('./global.json?v=' + timestamp),
                        fetch('./factories.json?v=' + timestamp)
                    ]);

                    if (countriesRes.ok) Object.assign(CoffeeData, await countriesRes.json());
                    if (globalRes.ok) Object.assign(CoffeeData, await globalRes.json());
                    if (factoriesRes.ok) Object.assign(CoffeeData, await factoriesRes.json());
                    
                    console.log("✅ Données chargées.");

                } catch (e) {
                    console.error("⚠️ Erreur JSON :", e);
                }

                // 3. Dessiner la carte et activer les données
                this.renderMap();
                if (CoffeeData.globalIntel) {
                    this.updateData(CoffeeData.globalIntel);
                }
            },

            updateData: function(data) {
                // Mise à jour Dashboard
                CoffeeData.globalIntel = data;
                App.ui.renderDashboard();

                // Mise à jour Ticker
                if (data.ticker && Array.isArray(data.ticker)) {
                    const ticker = document.querySelector('.osint-ticker');
                    if(ticker) {
                        ticker.innerHTML = ''; 
                        data.ticker.forEach(item => {
                            let c = 'osint-val-neutral';
                            if(item.trend === 'up') c = 'osint-val-up';
                            if(item.trend === 'down') c = 'osint-val-down';
                            if(item.trend === 'risk') c = 'osint-val-risk';
                            const span = document.createElement('span');
                            span.className = 'osint-item';
                            span.innerHTML = `<span class="osint-label">${item.label}</span> <span class="${c}">${item.value}</span>`;
                            ticker.appendChild(span);
                        });
                    }
                }

                // Mise à jour Alertes Rouges
                if (data.alerts && Array.isArray(data.alerts)) {
                    this.layers.newsAlerts.clearLayers();
                    data.alerts.forEach(alert => {
                        if(alert.loc) {
                            const redPulseIcon = L.divIcon({ 
                                className: 'custom', 
                                html: `<div class="relative flex h-4 w-4"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-red-600 border-2 border-white"></span></div>`,
                                iconSize: [16,16], iconAnchor: [8,8]
                            });
                            L.marker(alert.loc, { icon: redPulseIcon, pane: 'alertPane' })
                                .bindPopup(`<div class="font-mono text-xs p-2 text-white bg-slate-900 border-l-4 border-red-500"><div class="font-bold text-red-400 mb-1 uppercase">${alert.t || 'Alert'}</div><div>${alert.v || ''}</div></div>`)
                                .addTo(this.layers.newsAlerts);
                        }
                    });
                }
            },

            renderMap: function() {
                Object.values(this.layers).forEach(layer => {
                    if (layer && layer !== this.layers.newsAlerts && typeof layer.clearLayers === 'function') layer.clearLayers();
                });

                // Routes
                if (CoffeeData.routes) {
                    CoffeeData.routes.forEach(r => {
                        if(r.path) L.polyline(r.path, { color: r.color, weight: 2, opacity: 0.8, className: 'route-flow' }).bindTooltip(r.name).addTo(this.layers.logistics);
                    });
                }

                // Ports
                if (CoffeeData.ports) {
                    CoffeeData.ports.forEach(p => {
                        if(p.l) {
                            const icon = L.divIcon({ className: 'custom', html: `<div class='port-icon w-6 h-6'><i class="fa-solid fa-anchor"></i></div>` });
                            L.marker(p.l, { icon: icon }).bindPopup(`Port of ${p.n}`).addTo(this.layers.ports);
                        }
                    });
                }

                // Pays
                if(CoffeeData.countries) {
                    for (const [key, data] of Object.entries(CoffeeData.countries)) {
                        if (!data.lat || !data.lng) continue;
                        const isProducer = data.type === 'producer';
                        const targetLayer = isProducer ? this.layers.producers : this.layers.consumers;
                        const cssClass = isProducer ? (data.status === 'Active Harvest' ? 'data-icon producer harvesting' : 'data-icon producer') : 'data-icon consumer';
                        const marker = L.marker([data.lat, data.lng], { icon: L.divIcon({ className: 'custom', html: `<div class="${cssClass} w-3 h-3"></div>` }) });
                        let statsHtml = isProducer ? `<div><span class="text-gray-400">PROD:</span> ${data.prod}</div><div><span class="text-gray-400">STOCK:</span> ${data.stock}</div>` : `<div><span class="text-gray-400">CONS:</span> ${data.cons}</div><div><span class="text-gray-400">STOCK:</span> ${data.stock}</div>`;
                        marker.bindPopup(`<div class="p-3 font-mono text-xs text-gray-100 bg-slate-900 border border-slate-700 rounded min-w-[180px]"><div class="font-bold text-sm mb-1 border-b border-slate-600 pb-1 text-white">${key}</div><div class="grid grid-cols-2 gap-2 my-2 text-slate-300">${statsHtml}</div>${data.intel ? `<div class="mb-2 p-1 bg-slate-800 rounded text-[10px] text-gray-300 border-l-2 border-emerald-500 pl-2 mt-1 italic">${data.intel}</div>` : ''}</div>`);
                        targetLayer.addLayer(marker);
                    }
                }

                // Usines
                if (CoffeeData.factories) {
                    CoffeeData.factories.forEach(fac => {
                        if (fac.l) {
                            const icon = L.divIcon({ className: 'custom', html: `<div class='factory-icon w-4 h-4'><i class="fa-solid fa-industry"></i></div>` });
                            L.marker(fac.l, { icon: icon }).bindPopup(`<div class="font-mono text-xs p-2 text-slate-200 bg-slate-900 border border-slate-700 rounded"><b>${fac.n}</b><br><span class="text-slate-400">${fac.c || ''}</span><br><span class="text-emerald-400">Cap: ${fac.cap || ''}</span></div>`).addTo(this.layers.factories);
                        }
                    });
                }
            },

            ui: {
                renderDashboard: function() {
                    const d = CoffeeData.globalIntel;
                    if(!d) return;
                    this.fillColumn('col-supply', d.supply, 'border-cat-supply text-cat-supply');
                    this.fillColumn('col-demand', d.demand, 'border-cat-demand text-cat-demand');
                    this.fillColumn('col-stocks', d.stocks, 'border-cat-stocks text-cat-stocks');
                    this.fillColumn('col-futures', d.futures, 'border-cat-futures text-cat-futures');
                },
                fillColumn: function(id, items, colorClass) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (!items || items.length === 0) { el.innerHTML = '<div class="text-gray-500 text-xs italic text-center mt-4">No data</div>'; return; }
                    el.innerHTML = items.map(i => `<div class="news-card ${colorClass}" style="border-color: currentColor; color: #e2e8f0;"><div class="flex justify-between items-center mb-1"><span class="font-bold text-[10px] opacity-70 uppercase tracking-wide">${i.t}</span><span class="text-[9px] opacity-50">${i.date || ''}</span></div><div>${i.v}</div></div>`).join('');
                },
                togglePanel: function() {
                    const panel = document.getElementById('global-panel');
                    const icon = document.getElementById('toggle-icon');
                    panel.classList.toggle('retracted');
                    icon.style.transform = panel.classList.contains('retracted') ? 'rotate(180deg)' : 'rotate(0deg)';
                },
                openAiModal: function(title, loadingText) {
                    const overlay = document.getElementById('modal-overlay');
                    const modal = document.getElementById('ai-modal');
                    overlay.classList.remove('hidden');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    document.getElementById('ai-modal-title').innerText = title;
                    document.getElementById('ai-modal-content').innerHTML = `<div class="flex items-center gap-3 text-gray-500"><i class="fa-solid fa-circle-notch fa-spin"></i> ${loadingText}</div>`;
                    if(title === "Global Briefing") App.ai.generateGlobal();
                },
                closeAiModal: function() {
                    const overlay = document.getElementById('modal-overlay');
                    const modal = document.getElementById('ai-modal');
                    overlay.classList.add('hidden');
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                },
                updateModalContent: function(text) {
                    let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>').replace(/^- (.*)/gm, '<li class="ml-4 list-disc">$1</li>');
                    document.getElementById('ai-modal-content').innerHTML = html;
                }
            },

            ai: {
                generateGlobal: function() { setTimeout(() => { App.ui.updateModalContent("<strong>AI Market Overview</strong><br><br>Data sourced from your JSON feed."); }, 500); },
                analyzeCountry: async function(country) { App.ui.openAiModal(`${country} Deep Dive`, `Analyzing ${country}...`); setTimeout(() => { App.ui.updateModalContent(`<strong>${country} Market Analysis</strong><br>Analysis would pull from live feeds here.`); }, 1000); }
            },

            uploader: { init: function() {} }
        };

        window.onload = function() { App.init(); };
    </script>
</body>
</html>
